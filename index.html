<!DOCTYPE html>
<html>
<head>
  <title>Kyron Esports â€“ Leaderboards</title>
  <link rel="icon" type="image/png" href="icon.png">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="stylesIndex.css">
</head>
<body>
  <div class="brand">
    <img src="KYRON.png" alt="Kyron Esports Logo" class="brand-logo">
    <div class="brand-title">KYRON-Esports</div>
  </div>


<div class="top-actions">
  <button onclick="location.href='https://www.youtube.com/@kyron-esports'">
    ğŸ¦ YouTube
  </button>

  <button onclick="location.href='https://www.instagram.com/kyrongroups?utm_source=ig_web_button_share_sheet&igsh=ZDNlZDc0MzIxNw=='">
    ğŸ‘¥ Instagram
  </button>

  <button onclick="location.href='admin-gate.html'" class="admin-btn">
    ğŸ” Admin Login
  </button>
</div>

<div class="section info-section">
  <h2>ğŸš€ About Kyron Esports</h2>

  <p>
    Kyron Esports is a competitive gaming community built to identify, rank,
    and promote skilled players through structured tournaments and transparent
    performance metrics.
  </p>

  <h3>ğŸ¯ Our Objective</h3>
  <p>
    Our goal is to grow Kyron Esports into a <strong>national-level esports club</strong>,
    providing fair competition, recognition, and opportunities for players
    to showcase their skills across India.
  </p>

  <h3>ğŸ“Š Ranking Calculation</h3>
  <p>
    Player rankings are calculated using an <strong>average rank points system</strong>.
    For each player:
  </p>
  <ul>
    <li>Rank points from every match are added</li>
    <li>Total points are divided by matches played</li>
    <li>This ensures consistency is rewarded, not just one good match</li>
  </ul>
</div>

<div class="section">
  <h2>ğŸŒ Global Leaderboard</h2>
  <p>Average performance across all matches</p>

  <table>
    <thead>
      <tr>
          <th>#</th>
        <th>Player (UID)</th>
        <th>Matches Played</th>
        <th>Avg Rank Points</th>
      </tr>
    </thead>
    <tbody id="leaderboard"></tbody>
  </table>
  <button id="toggleGlobal" style="margin-top:12px">
    ğŸ“‚ Show Full Leaderboard
  </button>

</div>



<div class="section">
  <h2>ğŸ® Match-wise Leaderboards</h2>
  <div id="matchLeaderboards"></div>
</div>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  query,
  orderBy
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDfzeLVOtRFWXozN4jKX9DfrrWjVFIGyuw",
  authDomain: "kyron-esports.firebaseapp.com",
  projectId: "kyron-esports",
  storageBucket: "kyron-esports.firebasestorage.app",
  messagingSenderId: "688589391933",
  appId: "1:688589391933:web:798e96fef9694af816c254",
  measurementId: "G-TK64VD9RP9"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ================= GLOBAL LEADERBOARD =================
const leaderboardBody = document.getElementById("leaderboard");
const players = {};

const matchesSnap = await getDocs(collection(db, "matches"));

for (const matchDoc of matchesSnap.docs) {
  const regSnap = await getDocs(
    collection(db, "matches", matchDoc.id, "registrations")
  );

  regSnap.forEach(docSnap => {
    const p = docSnap.data();
    if (!p.uid) return;

    if (!players[p.uid]) {
      players[p.uid] = {
        uid: p.uid,
        name: p.name,
        totalPoints: 0,
        matches: 0
      };
    }

    players[p.uid].totalPoints += Number(p.rankPoints || 0);
    players[p.uid].matches += 1;
  });
}

const ranked = Object.values(players)
  .map(p => ({ ...p, avgPoints: p.totalPoints / p.matches }))
  .sort((a, b) => b.avgPoints - a.avgPoints);

leaderboardBody.innerHTML = "";
let showAll = false;

function renderGlobalLeaderboard() {
  leaderboardBody.innerHTML = "";

  const list = showAll ? ranked : ranked.slice(0, 10);

  list.forEach((p, i) => {
    const rankClass =
      i === 0 ? "rank-1" :
      i === 1 ? "rank-2" :
      i === 2 ? "rank-3" : "";

    leaderboardBody.innerHTML += `
      <tr class="${rankClass}">
        <td>#${i + 1}</td>
        <td>
          <strong>${p.name}</strong><br>
          <small>UID: ${p.uid}</small>
        </td>
        <td>${p.matches}</td>
        <td>${p.avgPoints.toFixed(3)}</td>
      </tr>
    `;
  });
}

renderGlobalLeaderboard();

document.getElementById("toggleGlobal").onclick = () => {
  showAll = !showAll;
  document.getElementById("toggleGlobal").innerText =
    showAll ? "ğŸ“ Hide Full Leaderboard" : "ğŸ“‚ Show Full Leaderboard";
  renderGlobalLeaderboard();
};



// ================= MATCH-WISE LEADERBOARDS =================
const matchContainer = document.getElementById("matchLeaderboards");

const matchesQuery = query(
  collection(db, "matches"),
  orderBy("date", "desc")
);

const orderedMatchesSnap = await getDocs(matchesQuery);

for (const matchDoc of orderedMatchesSnap.docs) {
  const m = matchDoc.data();

  const regSnap = await getDocs(
    collection(db, "matches", matchDoc.id, "registrations")
  );

const playersArr = [];

regSnap.forEach(docSnap => {
  playersArr.push(docSnap.data());
});

// sort by rankPoints DESC
playersArr.sort((a, b) => (b.rankPoints || 0) - (a.rankPoints || 0));

let rows = "";

playersArr.forEach((p, i) => {
  rows += `
    <tr>
      <td>#${i + 1}</td>
      <td>${p.name}</td>
      <td>${p.rankPoints || 0}</td>
      <td>${p.kills || 0}</td>
      <td>${p.damage || 0}</td>
      <td>${p.knockdowns || 0}</td>
    </tr>
  `;
});


let dateStr = "Unknown";

if (m.date) {
  let d;

  if (typeof m.date.toDate === "function") {
    d = m.date.toDate();           // Firestore Timestamp
  } else if (typeof m.date === "number") {
    d = new Date(m.date);          // milliseconds
  } else if (typeof m.date === "string") {
    d = new Date(m.date);          // string date
  }

  if (d && !isNaN(d)) {
    const day = String(d.getDate()).padStart(2, "0");
    const month = String(d.getMonth() + 1).padStart(2, "0");
    const year = d.getFullYear();

    dateStr = `${day}/${month}/${year}`;
  }
}

let registerBtn = "";

if (m.formLink) {
  registerBtn = `
    <a href="${m.formLink}" target="_blank" class="register-btn">
      ğŸ“ Register
    </a>
  `;
}


const top3 = playersArr.slice(0, 3);
const rest = playersArr.slice(3);

let topRows = "";
top3.forEach((p, i) => {
  topRows += `
    <tr>
      <td>#${i + 1}</td>
      <td>${p.name}</td>
      <td>${p.rankPoints || 0}</td>
      <td>${p.kills || 0}</td>
      <td>${p.damage || 0}</td>
      <td>${p.knockdowns || 0}</td>
    </tr>
  `;
});

let restRows = "";
rest.forEach((p, i) => {
  restRows += `
    <tr>
      <td>#${i + 4}</td>
      <td>${p.name}</td>
      <td>${p.rankPoints || 0}</td>
      <td>${p.kills || 0}</td>
      <td>${p.damage || 0}</td>
      <td>${p.knockdowns || 0}</td>
    </tr>
  `;
});

const cardId = `match-${matchDoc.id}`;

matchContainer.innerHTML += `
  <div class="match-card">
    <h3>${m.matchName || "Unnamed Match"}</h3>

    <div class="match-meta">
      <strong>Game:</strong> ${m.game || "-"} |
      <strong>Mode:</strong> ${m.mode || "-"} |
      <strong>Date:</strong> ${dateStr}<br>
      <strong>Registered Players:</strong> ${playersArr.length}
    </div>

    ${registerBtn}

    <table>
      <thead>
        <tr>
          <th>#</th><th>Player</th><th>RP</th><th>K</th><th>Dmg</th><th>Kn</th>
        </tr>
      </thead>
      <tbody>
        ${topRows}
      </tbody>
      <tbody id="${cardId}" style="display:none">
        ${restRows}
      </tbody>
    </table>

    ${rest.length ? `
      <button class="drawer-btn"
        onclick="
          const el = document.getElementById('${cardId}');
          el.style.display = el.style.display === 'none' ? 'table-row-group' : 'none';
          event.target.innerText =
            el.style.display === 'none' ? 'ğŸ“‚ Show All Players' : 'ğŸ“ Hide Players';
        ">
        ğŸ“‚ Show All Players
      </button>
    ` : ""}
  </div>
`;

}
</script>

</body>
</html>
